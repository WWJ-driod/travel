<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹¡æ‘æ—…æ¸¸ä¹‹å®¶ - ç”°å›­é£å…‰åœ°å›¾</title>
    <style>
        body {
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #8BC34A 0%, #4CAF50 50%, #388E3C 100%);
            min-height: 100vh;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="field" x="0" y="0" width="25" height="25" patternUnits="userSpaceOnUse"><rect width="25" height="25" fill="%234CAF50"/><circle cx="12.5" cy="12.5" r="2" fill="%238BC34A" opacity="0.3"/></pattern></defs><rect width="100" height="100" fill="url(%23field)"/></svg>');
        }
        
        .header {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border-bottom: 3px solid rgba(121, 85, 72, 0.3);
        }
        
        .main-title {
            font-size: 2.8rem;
            font-weight: bold;
            color: #3E2723;
            margin: 0;
            text-shadow: 2px 2px 8px rgba(255, 255, 255, 0.5);
            letter-spacing: 2px;
            background: linear-gradient(45deg, #5D4037, #8BC34A);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .welcome-text {
            font-size: 1.3rem;
            color: #5D4037;
            margin: 15px 0 0 0;
            font-weight: 500;
        }
        
        .map-container {
            margin: 30px auto;
            max-width: 1400px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 25px;
            padding: 35px;
            backdrop-filter: blur(12px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(121, 85, 72, 0.2);
        }
        
        /* æ–°å¸ƒå±€æ ·å¼ */
        .layout-container {
            display: flex;
            gap: 30px;
            min-height: 600px;
        }
        
        .map-section {
            flex: 1;
            min-width: 0;
        }
        
        .spots-section {
            flex: 1;
            min-width: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(139, 195, 74, 0.3);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            max-height: 600px;
        }
        
        .spots-section h3 {
            color: white;
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }
        
        .spot-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .spot-item {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
        }
        
        .spot-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(139, 195, 74, 0.3);
        }
        
        .spot-item.active {
            background: rgba(139, 195, 74, 0.3);
            border-color: #8BC34A;
        }
        
        .spot-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            margin-bottom: 8px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .spot-type {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
        }
        
        .spot-description {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.4;
        }
        
        .map-title {
            font-size: 2.2rem;
            color: #5D4037;
            text-align: center;
            margin-bottom: 35px;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
            font-weight: bold;
        }
        
        /* åœ°å›¾æ§åˆ¶é¢æ¿æ ·å¼ */
        .map-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            flex: 1;
            max-width: 400px;
        }
        
        .search-input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #8BC34A;
            border-radius: 30px;
            background: rgba(255, 255, 255, 0.95);
            font-size: 1.1rem;
            outline: none;
            box-shadow: 0 4px 15px rgba(139, 195, 74, 0.3);
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            border-color: #689F38;
            box-shadow: 0 6px 20px rgba(139, 195, 74, 0.5);
        }
        
        .search-btn {
            background: linear-gradient(45deg, #689F38, #558B2F);
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(104, 159, 56, 0.4);
        }
        
        .search-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(104, 159, 56, 0.6);
            background: linear-gradient(45deg, #558B2F, #33691E);
        }
        
        .zoom-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .zoom-btn {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #8BC34A;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 3px 12px rgba(139, 195, 74, 0.3);
            color: #5D4037;
            font-weight: bold;
        }
        
        .zoom-btn:hover {
            background: #8BC34A;
            color: white;
            transform: scale(1.15);
            box-shadow: 0 5px 18px rgba(139, 195, 74, 0.5);
        }
        
        .zoom-level {
            color: #5D4037;
            font-weight: bold;
            min-width: 70px;
            text-align: center;
            font-size: 1.1rem;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
        }
        
        /* åœ°å›¾ç”»å¸ƒæ ·å¼ */
        .map-canvas-container {
            position: relative;
            width: 100%;
            height: 600px;
            background: linear-gradient(135deg, #E8F5E8 0%, #C8E6C9 100%);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            border: 3px solid #8BC34A;
        }
        
        #mapCanvas {
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        
        #mapCanvas:active {
            cursor: grabbing;
        }
        
        /* åœ°å›¾å›¾ä¾‹æ ·å¼ */
        .map-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            font-size: 0.9rem;
        }
        
        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        /* æ™¯ç‚¹ä¿¡æ¯é¢æ¿ */
        .spot-info-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .spot-info-title {
            font-size: 1.5rem;
            color: white;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .spot-info-content {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            font-size: 1rem;
        }
        
        .logout-btn {
            background: linear-gradient(45deg, #D84315, #BF360C);
            color: white;
            border: none;
            padding: 14px 35px;
            font-size: 1.1rem;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 25px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(215, 67, 21, 0.4);
        }
        
        .logout-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(215, 67, 21, 0.6);
            background: linear-gradient(45deg, #BF360C, #8D6E63);
        }
        
        .current-time {
            font-size: 1.2rem;
            color: white;
            text-align: center;
            margin-top: 20px;
            opacity: 0.9;
        }
        
        /* åˆä½œç¤¾èœå•æ ·å¼ */
        .cooperative-menu {
            margin: 30px 0;
        }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }
        
        .menu-item {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 35px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(12px);
            border: 2px solid rgba(139, 195, 74, 0.3);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }
        
        .menu-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(139, 195, 74, 0.3);
            border-color: rgba(139, 195, 74, 0.6);
        }
        
        .menu-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .menu-item h3 {
            color: white;
            font-size: 1.3rem;
            margin-bottom: 10px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.4);
        }
        
        .menu-item p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        @media (max-width: 768px) {
            .map-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                max-width: none;
            }
            
            .map-canvas-container {
                height: 400px;
            }
            
            .main-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="main-title">æ—…æ¸¸è€…ä¹‹å®¶</h1>
        <div class="welcome-text" id="welcomeText">æ¬¢è¿æ¥åˆ°äº¤äº’å¼æ—…æ¸¸åœ°å›¾</div>
    </div>
    
    <div class="map-container">
        <h2 class="map-title">äº¤äº’å¼æ—…æ¸¸åœ°å›¾</h2>
        
        <!-- åœ°å›¾æ§åˆ¶é¢æ¿ -->
        <div class="map-controls">
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢æ™¯ç‚¹åç§°...">
                <button class="search-btn" onclick="searchSpot()">æœç´¢</button>
            </div>
            
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomOut()">-</button>
                <span class="zoom-level" id="zoomLevel">5x</span>
                <button class="zoom-btn" onclick="zoomIn()">+</button>
                <button class="search-btn" onclick="resetMap()" style="margin-left: 15px;">é‡ç½®åœ°å›¾</button>
                <button class="search-btn" onclick="clearUserMarkers()" style="margin-left: 15px; background: linear-gradient(45deg, #FF5252, #D32F2F);">æ¸…é™¤æ ‡æ³¨</button>
            </div>
        </div>
        
        <!-- æ ‡æ³¨åŠŸèƒ½è¯´æ˜ -->
        <div style="text-align: center; margin: 15px 0; color: white; font-size: 0.9rem;">
            ğŸ’¡ æŒ‰ä½ Shift é”®ç‚¹å‡»åœ°å›¾å¯æ·»åŠ æ ‡æ³¨ç‚¹
        </div>
        
        <!-- æ–°å¸ƒå±€ï¼šåœ°å›¾åœ¨å·¦ï¼Œæ ‡æ³¨ç‚¹åœ¨å³ -->
        <div class="layout-container">
            <!-- å·¦ä¾§åœ°å›¾åŒºåŸŸ -->
            <div class="map-section">
                <div class="map-canvas-container">
                    <canvas id="mapCanvas"></canvas>
                    
                    <!-- åœ°å›¾å›¾ä¾‹ -->
                    <div class="map-legend">
                        <div class="legend-title">å›¾ä¾‹</div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff6b6b;"></div>
                            <span>çƒ­é—¨æ™¯ç‚¹</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4CAF50;"></div>
                            <span>è‡ªç„¶é£å…‰</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #2196F3;"></div>
                            <span>å†å²é—è¿¹</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§æ ‡æ³¨ç‚¹åŒºåŸŸ -->
            <div class="spots-section">
                <h3>æ™¯ç‚¹åˆ—è¡¨</h3>
                <div class="spot-list" id="spotList">
                    <!-- æ™¯ç‚¹åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <!-- æ™¯ç‚¹ä¿¡æ¯é¢æ¿ -->
        <div class="spot-info-panel" id="spotInfoPanel" style="display: none;">
            <h3 class="spot-info-title" id="spotInfoTitle">æ™¯ç‚¹ä¿¡æ¯</h3>
            <div class="spot-info-content" id="spotInfoContent"></div>
        </div>
        
        <div style="text-align: center;">
            <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
        
        <div class="current-time" id="currentTime"></div>
    </div>

    <script>
        // åœ°å›¾ç›¸å…³å˜é‡
        let mapZoom = 5;
        let mapOffsetX = 0;
        let mapOffsetY = 0;
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        let canvas, ctx;
        
        // ä¹¡æ‘åœ°å›¾æ™¯ç‚¹æ•°æ®
        const touristSpots = [
            {
                id: 'river1',
                name: 'æ¸…æºªæ²³',
                description: 'æ¸…æºªæ²³ï¼šèœ¿èœ’ç©¿è¿‡ä¹¡æ‘çš„æ¸…æ¾ˆæ²³æµï¼Œä¸¤å²¸ç»¿æ ‘æˆè«ï¼Œæ˜¯å‚é’“å’Œæ³›èˆŸçš„å¥½å»å¤„ã€‚',
                type: 'æ²³æµ',
                lat: 45,
                lng: 45,
                color: '#2196F3'
            },
            {
                id: 'farm1',
                name: 'ç”°å›­å†œèˆ',
                description: 'ç”°å›­å†œèˆï¼šä¼ ç»Ÿçš„ä¹¡æ‘å†œèˆï¼Œå‘¨å›´ç¯ç»•ç€å†œç”°å’Œæœå›­ï¼Œæä¾›å†œå®¶ä¹ä½“éªŒã€‚',
                type: 'å†œèˆ',
                lat: 40,
                lng: 50,
                color: '#8BC34A'
            },
            {
                id: 'lake1',
                name: 'ç¢§æ³¢æ¹–',
                description: 'ç¢§æ³¢æ¹–ï¼šå®é™çš„ä¹¡æ‘æ¹–æ³Šï¼Œæ¹–æ°´æ¸…æ¾ˆè§åº•ï¼Œæ˜¯è§‚é¸Ÿå’Œä¼‘é—²çš„å¥½åœ°æ–¹ã€‚',
                type: 'æ¹–æ³Š',
                lat: 50,
                lng: 40,
                color: '#2196F3'
            },
            {
                id: 'orchard1',
                name: 'æœå›­',
                description: 'æœå›­ï¼šç§æ¤å„ç§æ°´æœçš„æœå›­ï¼Œæ˜¥å­£èµèŠ±ï¼Œç§‹å­£é‡‡æ‘˜ï¼Œå››å­£çš†å®œã€‚',
                type: 'æœå›­',
                lat: 35,
                lng: 55,
                color: '#FF9800'
            },
            {
                id: 'village1',
                name: 'å¤æ‘è½',
                description: 'å¤æ‘è½ï¼šä¿å­˜å®Œå¥½çš„ä¼ ç»Ÿæ‘è½ï¼ŒçŸ³æ¿è·¯ã€è€æˆ¿å­ï¼Œå……æ»¡å†å²éŸµå‘³ã€‚',
                type: 'æ‘è½',
                lat: 55,
                lng: 35,
                color: '#795548'
            },
            {
                id: 'bridge1',
                name: 'çŸ³æ¡¥',
                description: 'çŸ³æ¡¥ï¼šå¤è€çš„çŸ³æ‹±æ¡¥ï¼Œè¿æ¥ä¸¤å²¸ï¼Œæ˜¯ä¹¡æ‘çš„æ ‡å¿—æ€§å»ºç­‘ã€‚',
                type: 'æ¡¥æ¢',
                lat: 42,
                lng: 42,
                color: '#607D8B'
            },
            {
                id: 'field1',
                name: 'éº¦ç”°',
                description: 'éº¦ç”°ï¼šé‡‘é»„è‰²çš„éº¦ç”°ï¼Œé£å¹éº¦æµªï¼Œå±•ç°ä¹¡æ‘ä¸°æ”¶çš„æ™¯è±¡ã€‚',
                type: 'å†œç”°',
                lat: 48,
                lng: 48,
                color: '#FFC107'
            }
        ];
        
        // ç”¨æˆ·æ ‡æ³¨ç‚¹æ•°ç»„
        let userMarkers = [];
        
        // æ—¶é—´æ›´æ–°å‡½æ•°
        function updateTime() {
            const now = new Date();
            
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const timeString = `${hours}:${minutes}:${seconds}`;
            
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const weekday = weekdays[now.getDay()];
            
            const fullDateString = `${year}å¹´${month}æœˆ${day}æ—¥`;
            const weekdayString = `æ˜ŸæœŸ${weekday}`;
            
            document.getElementById('currentTime').innerHTML = 
                `å½“å‰æ—¶é—´ï¼š${timeString} | ${fullDateString} ${weekdayString}`;
        }
        
        // ç”Ÿæˆæ™¯ç‚¹åˆ—è¡¨
        function generateSpotList() {
            const spotList = document.getElementById('spotList');
            spotList.innerHTML = '';
            
            touristSpots.forEach((spot, index) => {
                const spotItem = document.createElement('div');
                spotItem.className = 'spot-item';
                spotItem.innerHTML = `
                    <div class="spot-name">${spot.name}</div>
                    <div class="spot-type">ç±»å‹ï¼š${spot.type}</div>
                    <div class="spot-description">${spot.description}</div>
                `;
                
                spotItem.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
                    document.querySelectorAll('.spot-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // æ·»åŠ å½“å‰æ¿€æ´»çŠ¶æ€
                    spotItem.classList.add('active');
                    
                    // æ˜¾ç¤ºæ™¯ç‚¹ä¿¡æ¯
                    showSpotInfo(spot);
                    
                    // å°†åœ°å›¾ä¸­å¿ƒç§»åŠ¨åˆ°è¯¥æ™¯ç‚¹
                    const {x, y} = latLngToCanvas(spot.lat, spot.lng);
                    mapOffsetX = canvas.width / 2 - x;
                    mapOffsetY = canvas.height / 2 - y;
                    mapZoom = 7; // æ”¾å¤§åˆ°æ›´è¿‘çš„è§†å›¾
                    updateZoomLevel();
                    renderMap();
                });
                
                spotList.appendChild(spotItem);
            });
        }
        
        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            canvas = document.getElementById('mapCanvas');
            ctx = canvas.getContext('2d');
            
            // è®¾ç½®ç”»å¸ƒå°ºå¯¸
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // åŠ è½½ç”¨æˆ·æ ‡æ³¨ç‚¹
            loadUserMarkers();
            
            // ç”Ÿæˆæ™¯ç‚¹åˆ—è¡¨
            generateSpotList();
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            canvas.addEventListener('mousedown', startDrag);
            canvas.addEventListener('mousemove', dragMap);
            canvas.addEventListener('mouseup', stopDrag);
            canvas.addEventListener('mouseleave', stopDrag);
            canvas.addEventListener('wheel', handleZoom);
            canvas.addEventListener('click', handleMapClick);
            
            // åˆå§‹æ¸²æŸ“
            renderMap();
            
            // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è®¾ç½®ç”»å¸ƒå°ºå¯¸
            window.addEventListener('resize', function() {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                renderMap();
            });
        }
        
        // æ¸…é™¤æ‰€æœ‰ç”¨æˆ·æ ‡æ³¨ç‚¹
        function clearUserMarkers() {
            if (userMarkers.length === 0) {
                alert('å½“å‰æ²¡æœ‰ç”¨æˆ·æ ‡æ³¨ç‚¹');
                return;
            }
            
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç”¨æˆ·æ ‡æ³¨ç‚¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                userMarkers = [];
                localStorage.removeItem('userMarkers');
                renderMap();
                hideSpotInfo();
                alert('æ‰€æœ‰ç”¨æˆ·æ ‡æ³¨ç‚¹å·²æ¸…é™¤');
            }
        }
        
        // å¼€å§‹æ‹–æ‹½
        function startDrag(e) {
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            canvas.style.cursor = 'grabbing';
        }
        
        // æ‹–æ‹½åœ°å›¾
        function dragMap(e) {
            if (!isDragging) return;
            
            const deltaX = e.clientX - lastMouseX;
            const deltaY = e.clientY - lastMouseY;
            
            mapOffsetX += deltaX;
            mapOffsetY += deltaY;
            
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            
            renderMap();
        }
        
        // åœæ­¢æ‹–æ‹½
        function stopDrag() {
            isDragging = false;
            canvas.style.cursor = 'grab';
        }
        
        // å¤„ç†ç¼©æ”¾
        function handleZoom(e) {
            e.preventDefault();
            
            const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
            const oldZoom = mapZoom;
            
            mapZoom = Math.max(1, Math.min(10, mapZoom * zoomFactor));
            
            // è°ƒæ•´åç§»é‡ä»¥ä¿æŒç¼©æ”¾ä¸­å¿ƒ
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            mapOffsetX = mouseX - (mouseX - mapOffsetX) * (mapZoom / oldZoom);
            mapOffsetY = mouseY - (mouseY - mapOffsetY) * (mapZoom / oldZoom);
            
            updateZoomLevel();
            renderMap();
        }
        
        // æ”¾å¤§
        function zoomIn() {
            mapZoom = Math.min(10, mapZoom + 1);
            updateZoomLevel();
            renderMap();
        }
        
        // ç¼©å°
        function zoomOut() {
            mapZoom = Math.max(1, mapZoom - 1);
            updateZoomLevel();
            renderMap();
        }
        
        // é‡ç½®åœ°å›¾
        function resetMap() {
            mapZoom = 5;
            mapOffsetX = 0;
            mapOffsetY = 0;
            updateZoomLevel();
            renderMap();
            hideSpotInfo();
        }
        
        // æ›´æ–°ç¼©æ”¾çº§åˆ«æ˜¾ç¤º
        function updateZoomLevel() {
            document.getElementById('zoomLevel').textContent = mapZoom + 'x';
        }
        
        // ç»çº¬åº¦è½¬æ¢ä¸ºç”»å¸ƒåæ ‡ï¼ˆä¹¡æ‘åœ°å›¾åæ ‡ç³»ç»Ÿï¼‰
        function latLngToCanvas(lat, lng) {
            // ä¹¡æ‘åœ°å›¾åæ ‡ç³»ç»Ÿï¼ˆ0-90çº¬åº¦ï¼Œ0-90ç»åº¦ï¼‰
            const centerLat = 45;
            const centerLng = 45;
            const scale = 800 / mapZoom;
            
            const x = (lng - centerLng) * scale + canvas.width / 2 + mapOffsetX;
            const y = (centerLat - lat) * scale + canvas.height / 2 + mapOffsetY;
            
            return { x, y };
        }
        
        // æ¸²æŸ“ä¹¡æ‘åœ°å›¾
        function renderMap() {
            // æ¸…é™¤ç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶å¤©ç©ºèƒŒæ™¯
            const skyGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            skyGradient.addColorStop(0, '#87CEEB');
            skyGradient.addColorStop(1, '#E0F7FA');
            ctx.fillStyle = skyGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶è¿œå±±
            ctx.fillStyle = '#78909C';
            ctx.beginPath();
            ctx.moveTo(0, canvas.height * 0.3);
            ctx.lineTo(canvas.width * 0.2, canvas.height * 0.2);
            ctx.lineTo(canvas.width * 0.4, canvas.height * 0.25);
            ctx.lineTo(canvas.width * 0.6, canvas.height * 0.18);
            ctx.lineTo(canvas.width * 0.8, canvas.height * 0.22);
            ctx.lineTo(canvas.width, canvas.height * 0.3);
            ctx.lineTo(canvas.width, canvas.height);
            ctx.lineTo(0, canvas.height);
            ctx.closePath();
            ctx.fill();
            
            // ç»˜åˆ¶è‰åœ°
            const grassGradient = ctx.createLinearGradient(0, canvas.height * 0.3, 0, canvas.height);
            grassGradient.addColorStop(0, '#7CB342');
            grassGradient.addColorStop(1, '#558B2F');
            ctx.fillStyle = grassGradient;
            ctx.fillRect(0, canvas.height * 0.3, canvas.width, canvas.height * 0.7);
            
            // ç»˜åˆ¶æ²³æµ
            ctx.strokeStyle = '#2196F3';
            ctx.lineWidth = 8;
            ctx.beginPath();
            ctx.moveTo(canvas.width * 0.1, canvas.height * 0.4);
            ctx.bezierCurveTo(
                canvas.width * 0.3, canvas.height * 0.35,
                canvas.width * 0.5, canvas.height * 0.45,
                canvas.width * 0.7, canvas.height * 0.4
            );
            ctx.bezierCurveTo(
                canvas.width * 0.9, canvas.height * 0.35,
                canvas.width * 0.8, canvas.height * 0.6,
                canvas.width * 0.6, canvas.height * 0.65
            );
            ctx.stroke();
            
            // ç»˜åˆ¶æ¹–æ³Š
            ctx.fillStyle = '#29B6F6';
            ctx.beginPath();
            ctx.ellipse(canvas.width * 0.8, canvas.height * 0.5, 60, 40, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // ç»˜åˆ¶å†œç”°
            drawFields();
            
            // ç»˜åˆ¶å†œèˆ
            drawFarmhouse(canvas.width * 0.4, canvas.height * 0.5);
            drawFarmhouse(canvas.width * 0.6, canvas.height * 0.6);
            
            // ç»˜åˆ¶çŸ³æ¡¥
            drawBridge(canvas.width * 0.4, canvas.height * 0.45);
            
            // ç»˜åˆ¶æœå›­
            drawOrchard(canvas.width * 0.3, canvas.height * 0.7);
            
            // ç»˜åˆ¶æ™¯ç‚¹æ ‡è®°
            touristSpots.forEach(spot => {
                const {x, y} = latLngToCanvas(spot.lat, spot.lng);
                
                // æ£€æŸ¥ç‚¹æ˜¯å¦åœ¨å¯è§†èŒƒå›´å†…
                if (x >= -20 && x <= canvas.width + 20 && y >= -20 && y <= canvas.height + 20) {
                    // ç»˜åˆ¶æ ‡è®°
                    ctx.fillStyle = spot.color;
                    ctx.beginPath();
                    ctx.arc(x, y, 8, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // æ ‡è®°å¤–åœˆ
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // æ™¯ç‚¹åç§°
                    ctx.fillStyle = '#333';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(spot.name, x, y - 15);
                }
            });
            
            // ç»˜åˆ¶ç”¨æˆ·æ ‡æ³¨ç‚¹
            drawUserMarkers();
        }
        
        // ç»˜åˆ¶å†œç”°
        function drawFields() {
            // éº¦ç”°
            ctx.fillStyle = '#FFD54F';
            ctx.fillRect(canvas.width * 0.1, canvas.height * 0.6, 120, 80);
            
            // è”¬èœç”°
            ctx.fillStyle = '#66BB6A';
            ctx.fillRect(canvas.width * 0.2, canvas.height * 0.7, 100, 60);
            
            // ç¨»ç”°
            ctx.fillStyle = '#81C784';
            ctx.fillRect(canvas.width * 0.5, canvas.height * 0.7, 150, 70);
        }
        
        // ç»˜åˆ¶å†œèˆ
        function drawFarmhouse(x, y) {
            // æˆ¿å±‹ä¸»ä½“
            ctx.fillStyle = '#8D6E63';
            ctx.fillRect(x - 25, y - 30, 50, 30);
            
            // å±‹é¡¶
            ctx.fillStyle = '#5D4037';
            ctx.beginPath();
            ctx.moveTo(x - 30, y - 30);
            ctx.lineTo(x, y - 50);
            ctx.lineTo(x + 30, y - 30);
            ctx.closePath();
            ctx.fill();
            
            // çª—æˆ·
            ctx.fillStyle = '#E3F2FD';
            ctx.fillRect(x - 20, y - 25, 15, 10);
            ctx.fillRect(x + 5, y - 25, 15, 10);
            
            // é—¨
            ctx.fillStyle = '#5D4037';
            ctx.fillRect(x - 5, y - 15, 10, 15);
        }
        
        // ç»˜åˆ¶çŸ³æ¡¥
        function drawBridge(x, y) {
            ctx.strokeStyle = '#78909C';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(x - 40, y);
            ctx.lineTo(x + 40, y);
            ctx.stroke();
            
            // æ¡¥å¢©
            for (let i = -30; i <= 30; i += 20) {
                ctx.beginPath();
                ctx.moveTo(x + i, y);
                ctx.lineTo(x + i, y + 10);
                ctx.stroke();
            }
        }
        
        // ç»˜åˆ¶æœå›­
        function drawOrchard(x, y) {
            // æœæ ‘
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 2; j++) {
                    const treeX = x + i * 40;
                    const treeY = y + j * 30;
                    
                    // æ ‘å¹²
                    ctx.fillStyle = '#5D4037';
                    ctx.fillRect(treeX - 3, treeY, 6, 20);
                    
                    // æ ‘å† 
                    ctx.fillStyle = '#388E3C';
                    ctx.beginPath();
                    ctx.arc(treeX, treeY - 10, 15, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }
        
        // ç»˜åˆ¶ç”¨æˆ·æ ‡æ³¨ç‚¹
        function drawUserMarkers() {
            userMarkers.forEach(marker => {
                const {x, y} = latLngToCanvas(marker.lat, marker.lng);
                
                // æ£€æŸ¥ç‚¹æ˜¯å¦åœ¨å¯è§†èŒƒå›´å†…
                if (x >= -20 && x <= canvas.width + 20 && y >= -20 && y <= canvas.height + 20) {
                    // ç»˜åˆ¶è‡ªå®šä¹‰æ ‡è®°ï¼ˆçº¢è‰²äº”è§’æ˜Ÿï¼‰
                    ctx.fillStyle = '#FF5252';
                    drawStar(ctx, x, y, 10, 5, 3);
                    
                    // æ ‡è®°å¤–åœˆ
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // æ ‡æ³¨åç§°
                    ctx.fillStyle = '#333';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(marker.name, x, y - 20);
                }
            });
        }
        
        // ç»˜åˆ¶äº”è§’æ˜Ÿ
        function drawStar(ctx, cx, cy, spikes, outerRadius, innerRadius) {
            let rot = Math.PI / 2 * 3;
            let x = cx;
            let y = cy;
            let step = Math.PI / spikes;

            ctx.beginPath();
            ctx.moveTo(cx, cy - outerRadius);
            
            for (let i = 0; i < spikes; i++) {
                x = cx + Math.cos(rot) * outerRadius;
                y = cy + Math.sin(rot) * outerRadius;
                ctx.lineTo(x, y);
                rot += step;

                x = cx + Math.cos(rot) * innerRadius;
                y = cy + Math.sin(rot) * innerRadius;
                ctx.lineTo(x, y);
                rot += step;
            }
            
            ctx.lineTo(cx, cy - outerRadius);
            ctx.closePath();
            ctx.fill();
        }
        
        // ç»˜åˆ¶æ²³æµ
        function drawRiver(points) {
            ctx.beginPath();
            points.forEach((point, index) => {
                const {x, y} = latLngToCanvas(point.lat, point.lng);
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
        }
        
        // å¤„ç†åœ°å›¾ç‚¹å‡»
        function handleMapClick(e) {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†æ™¯ç‚¹æ ‡è®°
            touristSpots.forEach(spot => {
                const {x, y} = latLngToCanvas(spot.lat, spot.lng);
                const distance = Math.sqrt(Math.pow(mouseX - x, 2) + Math.pow(mouseY - y, 2));
                
                if (distance <= 15) {
                    showSpotInfo(spot);
                    return;
                }
            });
            
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†ç”¨æˆ·æ ‡æ³¨ç‚¹
            userMarkers.forEach(marker => {
                const {x, y} = latLngToCanvas(marker.lat, marker.lng);
                const distance = Math.sqrt(Math.pow(mouseX - x, 2) + Math.pow(mouseY - y, 2));
                
                if (distance <= 15) {
                    showUserMarkerInfo(marker);
                    return;
                }
            });
            
            // å¦‚æœä¸æ˜¯ç‚¹å‡»æ ‡è®°ï¼Œåˆ™æ·»åŠ æ–°æ ‡æ³¨ç‚¹
            if (e.shiftKey) {
                addUserMarker(mouseX, mouseY);
            }
        }
        
        // æ·»åŠ ç”¨æˆ·æ ‡æ³¨ç‚¹
        function addUserMarker(x, y) {
            const markerName = prompt('è¯·è¾“å…¥æ ‡æ³¨ç‚¹åç§°ï¼š');
            if (!markerName) return;
            
            const markerDescription = prompt('è¯·è¾“å…¥æ ‡æ³¨ç‚¹æè¿°ï¼š');
            
            // å°†ç”»å¸ƒåæ ‡è½¬æ¢ä¸ºç»çº¬åº¦
            const {lat, lng} = canvasToLatLng(x, y);
            
            const newMarker = {
                id: 'marker_' + Date.now(),
                name: markerName,
                description: markerDescription || 'ç”¨æˆ·è‡ªå®šä¹‰æ ‡æ³¨ç‚¹',
                type: 'è‡ªå®šä¹‰æ ‡æ³¨',
                lat: lat,
                lng: lng,
                color: '#FF5252',
                timestamp: new Date().toLocaleString()
            };
            
            userMarkers.push(newMarker);
            renderMap();
            
            // ä¿å­˜åˆ°localStorage
            saveUserMarkers();
        }
        
        // ç”»å¸ƒåæ ‡è½¬æ¢ä¸ºç»çº¬åº¦
        function canvasToLatLng(x, y) {
            const centerLat = 45;
            const centerLng = 45;
            const scale = 800 / mapZoom;
            
            const lng = (x - canvas.width / 2 - mapOffsetX) / scale + centerLng;
            const lat = centerLat - (y - canvas.height / 2 - mapOffsetY) / scale;
            
            return { lat, lng };
        }
        
        // æ˜¾ç¤ºç”¨æˆ·æ ‡æ³¨ç‚¹ä¿¡æ¯
        function showUserMarkerInfo(marker) {
            document.getElementById('spotInfoTitle').textContent = marker.name;
            document.getElementById('spotInfoContent').innerHTML = `
                <p><strong>ç±»å‹ï¼š</strong>${marker.type}</p>
                <p><strong>æè¿°ï¼š</strong>${marker.description}</p>
                <p><strong>ä½ç½®ï¼š</strong>çº¬åº¦ ${marker.lat.toFixed(4)}Â°ï¼Œç»åº¦ ${marker.lng.toFixed(4)}Â°</p>
                <p><strong>åˆ›å»ºæ—¶é—´ï¼š</strong>${marker.timestamp}</p>
                <button class="search-btn" onclick="deleteMarker('${marker.id}')" style="margin-top: 10px;">åˆ é™¤æ ‡æ³¨</button>
            `;
            document.getElementById('spotInfoPanel').style.display = 'block';
        }
        
        // åˆ é™¤æ ‡æ³¨ç‚¹
        function deleteMarker(markerId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ ‡æ³¨ç‚¹å—ï¼Ÿ')) {
                userMarkers = userMarkers.filter(marker => marker.id !== markerId);
                renderMap();
                hideSpotInfo();
                saveUserMarkers();
            }
        }
        
        // ä¿å­˜ç”¨æˆ·æ ‡æ³¨ç‚¹åˆ°localStorage
        function saveUserMarkers() {
            localStorage.setItem('userMarkers', JSON.stringify(userMarkers));
        }
        
        // ä»localStorageåŠ è½½ç”¨æˆ·æ ‡æ³¨ç‚¹
        function loadUserMarkers() {
            const savedMarkers = localStorage.getItem('userMarkers');
            if (savedMarkers) {
                userMarkers = JSON.parse(savedMarkers);
            }
        }
        
        // æ˜¾ç¤ºæ™¯ç‚¹ä¿¡æ¯
        function showSpotInfo(spot) {
            document.getElementById('spotInfoTitle').textContent = spot.name;
            document.getElementById('spotInfoContent').innerHTML = `
                <p><strong>ç±»å‹ï¼š</strong>${spot.type}</p>
                <p><strong>æè¿°ï¼š</strong>${spot.description}</p>
                <p><strong>ä½ç½®ï¼š</strong>çº¬åº¦ ${spot.lat}Â°ï¼Œç»åº¦ ${spot.lng}Â°</p>
            `;
            document.getElementById('spotInfoPanel').style.display = 'block';
        }
        
        // éšè—æ™¯ç‚¹ä¿¡æ¯
        function hideSpotInfo() {
            document.getElementById('spotInfoPanel').style.display = 'none';
        }
        
        // æœç´¢æ™¯ç‚¹
        function searchSpot() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            
            if (!searchTerm) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }
            
            const foundSpots = touristSpots.filter(spot => 
                spot.name.toLowerCase().includes(searchTerm) || 
                spot.type.toLowerCase().includes(searchTerm)
            );
            
            if (foundSpots.length === 0) {
                alert('æœªæ‰¾åˆ°ç›¸å…³æ™¯ç‚¹');
                return;
            }
            
            // æ˜¾ç¤ºç¬¬ä¸€ä¸ªåŒ¹é…çš„æ™¯ç‚¹
            const spot = foundSpots[0];
            showSpotInfo(spot);
            
            // å°†åœ°å›¾ä¸­å¿ƒç§»åŠ¨åˆ°è¯¥æ™¯ç‚¹
            const {x, y} = latLngToCanvas(spot.lat, spot.lng);
            mapOffsetX = canvas.width / 2 - x;
            mapOffsetY = canvas.height / 2 - y;
            mapZoom = 7; // æ”¾å¤§åˆ°æ›´è¿‘çš„è§†å›¾
            updateZoomLevel();
            renderMap();
        }
        
        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('username');
            localStorage.removeItem('userType');
            window.location.href = 'index.html';
        }
        
        // æ·»åŠ è§’è‰²èœå•æŒ‰é’®
        function addRoleMenuButton(userType) {
            const mapControls = document.querySelector('.map-controls');
            
            // åˆ›å»ºèœå•æŒ‰é’®
            const menuButton = document.createElement('button');
            menuButton.className = 'search-btn';
            menuButton.style.marginLeft = '15px';
            
            // æ ¹æ®ç”¨æˆ·ç±»å‹è®¾ç½®æŒ‰é’®æ–‡æœ¬å’ŒåŠŸèƒ½
            if (userType === 'village') {
                menuButton.textContent = 'æ‘å§”ç®¡ç†èœå•';
                menuButton.onclick = showVillageMenu;
            } else if (userType === 'cooperative') {
                menuButton.textContent = 'åˆä½œç¤¾ç®¡ç†èœå•';
                menuButton.onclick = showCooperativeMenu;
            } else if (userType === 'enterprise') {
                menuButton.textContent = 'ä¼ä¸šç®¡ç†èœå•';
                menuButton.onclick = showEnterpriseMenu;
            }
            
            // å°†æŒ‰é’®æ·»åŠ åˆ°æ§åˆ¶é¢æ¿
            mapControls.appendChild(menuButton);
        }
        
        // åˆä½œç¤¾ä¸“å±èœå•åŠŸèƒ½
        function showCooperativeMenu() {
            document.querySelector('.map-container').innerHTML = `
                <h2 class="map-title">åˆä½œç¤¾ç®¡ç†å¹³å°</h2>
                
                <div class="cooperative-menu">
                    <div class="menu-grid">
                        <div class="menu-item" onclick="publishResource()">
                            <div class="menu-icon">ğŸ“¦</div>
                            <h3>å‘å¸ƒèµ„æºä¿¡æ¯</h3>
                            <p>å‘å¸ƒå†œäº§å“ã€æ°‘å®¿ã€æ—…æ¸¸è®¾æ–½ç­‰èµ„æºä¿¡æ¯</p>
                        </div>
                        
                        <div class="menu-item" onclick="publishSkill()">
                            <div class="menu-icon">ğŸ”§</div>
                            <h3>å‘å¸ƒæŠ€èƒ½ä¿¡æ¯</h3>
                            <p>å‘å¸ƒå¯¼æ¸¸ã€æ‰‹å·¥è‰ºã€ç‰¹è‰²æœåŠ¡ç­‰æŠ€èƒ½ä¿¡æ¯</p>
                        </div>
                        
                        <div class="menu-item" onclick="browseSearch()">
                            <div class="menu-icon">ğŸ”</div>
                            <h3>æµè§ˆå’Œæœç´¢</h3>
                            <p>æŸ¥çœ‹å’Œæœç´¢å·²å‘å¸ƒçš„èµ„æºå’ŒæŠ€èƒ½ä¿¡æ¯</p>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 40px;">
                    <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
                
                <div class="current-time" id="currentTime"></div>
            `;
        }
        
        // æ‘å§”ä¸“å±èœå•åŠŸèƒ½
        function showVillageMenu() {
            document.querySelector('.map-container').innerHTML = `
                <h2 class="map-title">æ‘å§”ç®¡ç†å¹³å°</h2>
                
                <div class="cooperative-menu">
                    <div class="menu-grid">
                        <div class="menu-item" onclick="showStatistics()">
                            <div class="menu-icon">ğŸ“Š</div>
                            <h3>æ•°æ®ç»Ÿè®¡</h3>
                            <p>æŸ¥çœ‹ä¹¡æ‘æ—…æ¸¸æ•°æ®ç»Ÿè®¡ã€æ¸¸å®¢æµé‡åˆ†æã€æ”¶å…¥ç»Ÿè®¡ç­‰</p>
                        </div>
                        
                        <div class="menu-item" onclick="showResourceManagement()">
                            <div class="menu-icon">ğŸ˜ï¸</div>
                            <h3>èµ„æºç®¡ç†</h3>
                            <p>ç®¡ç†ä¹¡æ‘èµ„æºã€æ°‘å®¿ä¿¡æ¯ã€æ™¯ç‚¹è®¾æ–½ç­‰</p>
                        </div>
                        
                        <div class="menu-item" onclick="showVillagePlanning()">
                            <div class="menu-icon">ğŸ—ºï¸</div>
                            <h3>ä¹¡æ‘è§„åˆ’</h3>
                            <p>åˆ¶å®šä¹¡æ‘æ—…æ¸¸å‘å±•è§„åˆ’ã€åŸºç¡€è®¾æ–½å»ºè®¾è§„åˆ’</p>
                        </div>
                        
                        <div class="menu-item" onclick="showPolicyManagement()">
                            <div class="menu-icon">ğŸ“œ</div>
                            <h3>æ”¿ç­–ç®¡ç†</h3>
                            <p>å‘å¸ƒä¹¡æ‘æ—…æ¸¸æ”¿ç­–ã€ç®¡ç†åŠæ³•ã€é€šçŸ¥å…¬å‘Š</p>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 40px;">
                    <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
                
                <div class="current-time" id="currentTime"></div>
            `;
        }
        
        // æ—…æ¸¸ä¼ä¸šä¸“å±èœå•åŠŸèƒ½
        function showEnterpriseMenu() {
            document.querySelector('.map-container').innerHTML = `
                <h2 class="map-title">æ—…æ¸¸ä¼ä¸šç®¡ç†å¹³å°</h2>
                
                <div class="cooperative-menu">
                    <div class="menu-grid">
                        <div class="menu-item" onclick="publishRequirement()">
                            <div class="menu-icon">ğŸ“‹</div>
                            <h3>å‘å¸ƒéœ€æ±‚ä¿¡æ¯</h3>
                            <p>å‘å¸ƒæ—…æ¸¸äº§å“éœ€æ±‚ã€æœåŠ¡éœ€æ±‚ã€åˆä½œéœ€æ±‚ç­‰ä¿¡æ¯</p>
                        </div>
                        
                        <div class="menu-item" onclick="publishJob()">
                            <div class="menu-icon">ğŸ’¼</div>
                            <h3>å‘å¸ƒå²—ä½ä¿¡æ¯</h3>
                            <p>å‘å¸ƒå¯¼æ¸¸ã€å®¢æœã€è¿è¥ã€ç®¡ç†ç­‰å²—ä½æ‹›è˜ä¿¡æ¯</p>
                        </div>
                        
                        <div class="menu-item" onclick="browseEnterpriseInfo()">
                            <div class="menu-icon">ğŸ”</div>
                            <h3>æµè§ˆä¼ä¸šä¿¡æ¯</h3>
                            <p>æŸ¥çœ‹å’Œæœç´¢å·²å‘å¸ƒçš„éœ€æ±‚å’Œå²—ä½ä¿¡æ¯</p>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 40px;">
                    <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
                
                <div class="current-time" id="currentTime"></div>
            `;
        }
        
        // å‘å¸ƒèµ„æºä¿¡æ¯
        function publishResource() {
            const resourceInfo = prompt('è¯·è¾“å…¥è¦å‘å¸ƒçš„èµ„æºä¿¡æ¯ï¼ˆå†œäº§å“ã€æ°‘å®¿ã€æ—…æ¸¸è®¾æ–½ç­‰ï¼‰ï¼š');
            if (resourceInfo) {
                alert('èµ„æºä¿¡æ¯å‘å¸ƒæˆåŠŸï¼å‘å¸ƒå†…å®¹ï¼š' + resourceInfo);
            }
        }
        
        // å‘å¸ƒæŠ€èƒ½ä¿¡æ¯
        function publishSkill() {
            const skillInfo = prompt('è¯·è¾“å…¥è¦å‘å¸ƒçš„æŠ€èƒ½ä¿¡æ¯ï¼ˆå¯¼æ¸¸ã€æ‰‹å·¥è‰ºã€ç‰¹è‰²æœåŠ¡ç­‰ï¼‰ï¼š');
            if (skillInfo) {
                alert('æŠ€èƒ½ä¿¡æ¯å‘å¸ƒæˆåŠŸï¼å‘å¸ƒå†…å®¹ï¼š' + skillInfo);
            }
        }
        
        // æµè§ˆå’Œæœç´¢
        function browseSearch() {
            const searchTerm = prompt('è¯·è¾“å…¥æœç´¢å…³é”®è¯ï¼š');
            if (searchTerm) {
                alert(`æ­£åœ¨æœç´¢ï¼š${searchTerm}

æœç´¢ç»“æœï¼š
â€¢ å†œäº§å“ï¼šæœ‰æœºè”¬èœã€åœŸé¸¡è›‹
â€¢ æ°‘å®¿ï¼šä¹¡æ‘æ°‘å®¿ã€ç‰¹è‰²å†œå®¶é™¢
â€¢ æŠ€èƒ½ï¼šä¼ ç»Ÿæ‰‹å·¥è‰ºã€å¯¼æ¸¸æœåŠ¡`);
            }
        }
        
        // å‘å¸ƒéœ€æ±‚ä¿¡æ¯
        function publishRequirement() {
            const requirementInfo = prompt('è¯·è¾“å…¥è¦å‘å¸ƒçš„æ—…æ¸¸éœ€æ±‚ä¿¡æ¯ï¼ˆæ—…æ¸¸äº§å“éœ€æ±‚ã€æœåŠ¡éœ€æ±‚ã€åˆä½œéœ€æ±‚ç­‰ï¼‰ï¼š');
            if (requirementInfo) {
                // ä¿å­˜åˆ°localStorage
                const requirements = JSON.parse(localStorage.getItem('enterpriseRequirements') || '[]');
                const username = localStorage.getItem('username');
                const newRequirement = {
                    id: Date.now(),
                    content: requirementInfo,
                    publisher: username,
                    timestamp: new Date().toLocaleString(),
                    type: 'requirement'
                };
                requirements.push(newRequirement);
                localStorage.setItem('enterpriseRequirements', JSON.stringify(requirements));
                alert('éœ€æ±‚ä¿¡æ¯å‘å¸ƒæˆåŠŸï¼å‘å¸ƒå†…å®¹ï¼š' + requirementInfo);
            }
        }
        
        // å‘å¸ƒå²—ä½ä¿¡æ¯
        function publishJob() {
            const jobInfo = prompt('è¯·è¾“å…¥è¦å‘å¸ƒçš„å²—ä½ä¿¡æ¯ï¼ˆå²—ä½åç§°ã€è¦æ±‚ã€è–ªèµ„ç­‰ï¼‰ï¼š');
            if (jobInfo) {
                // ä¿å­˜åˆ°localStorage
                const jobs = JSON.parse(localStorage.getItem('enterpriseJobs') || '[]');
                const username = localStorage.getItem('username');
                const newJob = {
                    id: Date.now(),
                    content: jobInfo,
                    publisher: username,
                    timestamp: new Date().toLocaleString(),
                    type: 'job'
                };
                jobs.push(newJob);
                localStorage.setItem('enterpriseJobs', JSON.stringify(jobs));
                alert('å²—ä½ä¿¡æ¯å‘å¸ƒæˆåŠŸï¼å‘å¸ƒå†…å®¹ï¼š' + jobInfo);
            }
        }
        
        // æµè§ˆä¼ä¸šä¿¡æ¯
        function browseEnterpriseInfo() {
            const searchTerm = prompt('è¯·è¾“å…¥æœç´¢å…³é”®è¯ï¼ˆéœ€æ±‚/å²—ä½ï¼‰ï¼š');
            if (searchTerm) {
                const requirements = JSON.parse(localStorage.getItem('enterpriseRequirements') || '[]');
                const jobs = JSON.parse(localStorage.getItem('enterpriseJobs') || '[]');
                
                let result = `æ­£åœ¨æœç´¢ï¼š${searchTerm}

`;
                
                // æœç´¢éœ€æ±‚ä¿¡æ¯
                const matchedRequirements = requirements.filter(req => 
                    req.content.toLowerCase().includes(searchTerm.toLowerCase())
                );
                
                if (matchedRequirements.length > 0) {
                    result += 'éœ€æ±‚ä¿¡æ¯ï¼š';
                    matchedRequirements.forEach(req => {
                        result += `â€¢ ${req.content} (å‘å¸ƒè€…ï¼š${req.publisher}, æ—¶é—´ï¼š${req.timestamp})
`;
                    });
                }
                
                // æœç´¢å²—ä½ä¿¡æ¯
                const matchedJobs = jobs.filter(job => 
                    job.content.toLowerCase().includes(searchTerm.toLowerCase())
                );
                
                if (matchedJobs.length > 0) {
                    result += 'å²—ä½ä¿¡æ¯ï¼š';
                    matchedJobs.forEach(job => {
                        result += `â€¢ ${job.content} (å‘å¸ƒè€…ï¼š${job.publisher}, æ—¶é—´ï¼š${job.timestamp})
`;
                    });
                }
                
                if (matchedRequirements.length === 0 && matchedJobs.length === 0) {
                    result += 'æœªæ‰¾åˆ°ç›¸å…³ä¿¡æ¯';
                }
                
                alert(result);
            }
        }
        
        // æ‘å§”ç»Ÿè®¡åŠŸèƒ½
        function showStatistics() {
            document.querySelector('.map-container').innerHTML = `
                <h2 class="map-title">ä¹¡æ‘æ—…æ¸¸æ•°æ®ç»Ÿè®¡</h2>
                
                <div class="cooperative-menu">
                    <div class="menu-grid">
                        <div class="menu-item" onclick="showVisitorStatistics()">
                            <div class="menu-icon">ğŸ‘¥</div>
                            <h3>æ¸¸å®¢æµé‡ç»Ÿè®¡</h3>
                            <p>æŸ¥çœ‹æœˆåº¦æ¸¸å®¢æ•°é‡ã€æ¸¸å®¢æ¥æºåœ°åˆ†æã€æ¸¸å®¢åœç•™æ—¶é—´ç»Ÿè®¡</p>
                        </div>
                        
                        <div class="menu-item" onclick="showIncomeStatistics()">
                            <div class="menu-icon">ğŸ’°</div>
                            <h3>æ”¶å…¥ç»Ÿè®¡</h3>
                            <p>æŸ¥çœ‹æ—…æ¸¸æ”¶å…¥ã€æ°‘å®¿æ”¶å…¥ã€å†œäº§å“é”€å”®ç­‰æ”¶å…¥ç»Ÿè®¡</p>
                        </div>
                        
                        <div class="menu-item" onclick="showResourceStatistics()">
                            <div class="menu-icon">ğŸ¡</div>
                            <h3>èµ„æºåˆ©ç”¨ç»Ÿè®¡</h3>
                            <p>æŸ¥çœ‹æ°‘å®¿å…¥ä½ç‡ã€æ™¯ç‚¹è®¿é—®é‡ã€è®¾æ–½ä½¿ç”¨ç‡ç»Ÿè®¡</p>
                        </div>
                        
                        <div class="menu-item" onclick="showDevelopmentStatistics()">
                            <div class="menu-icon">ğŸ“ˆ</div>
                            <h3>å‘å±•æŒ‡æ ‡ç»Ÿè®¡</h3>
                            <p>æŸ¥çœ‹ä¹¡æ‘æ—…æ¸¸å‘å±•æŒ‡æ ‡ã€æ»¡æ„åº¦è°ƒæŸ¥ã€æŠ•èµ„å›æŠ¥åˆ†æ</p>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 40px;">
                    <button class="search-btn" onclick="showVillageMenu()" style="margin-right: 15px;">è¿”å›èœå•</button>
                    <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
                
                <div class="current-time" id="currentTime"></div>
            `;
            
            // æ›´æ–°æ—¶é—´
            updateTime();
        }
        
        // æ¸¸å®¢æµé‡ç»Ÿè®¡
        function showVisitorStatistics() {
            const statistics = generateVisitorStatistics();
            
            document.querySelector('.map-container').innerHTML = `
                <h2 class="map-title">æ¸¸å®¢æµé‡ç»Ÿè®¡</h2>
                
                <div style="background: rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 30px; margin: 20px 0;">
                    <h3 style="color: white; text-align: center; margin-bottom: 20px;">æœˆåº¦æ¸¸å®¢ç»Ÿè®¡</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 15px; text-align: center;">
                            <div style="font-size: 2rem; color: #4CAF50; font-weight: bold;">${statistics.totalVisitors}</div>
                            <div style="color: white;">æ€»æ¸¸å®¢æ•°</div>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 15px; text-align: center;">
                            <div style="font-size: 2rem; color: #2196F3; font-weight: bold;">${statistics.monthlyGrowth}%</div>
                            <div style="color: white;">æœˆåº¦å¢é•¿ç‡</div>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 15px; text-align: center;">
                            <div style="font-size: 2rem; color: #FF9800; font-weight: bold;">${statistics.averageStay}</div>
                            <div style="color: white;">å¹³å‡åœç•™å¤©æ•°</div>
                        </div>
                    </div>
                </div>
                
                <div style="background: rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 30px; margin: 20px 0;">
                    <h3 style="color: white; text-align: center; margin-bottom: 20px;">æ¸¸å®¢æ¥æºåœ°åˆ†å¸ƒ</h3>
                    <div style="color: white; line-height: 1.8;">
                        ${statistics.visitorOrigins.map(origin => 
                            `<div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>${origin.region}</span>
                                <span>${origin.percentage}% (${origin.count}äºº)</span>
                            </div>`
                        ).join('')}
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 40px;">
                    <button class="search-btn" onclick="showStatistics()" style="margin-right: 15px;">è¿”å›ç»Ÿè®¡</button>
                    <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
                
                <div class="current-time" id="currentTime"></div>
            `;
            
            // æ›´æ–°æ—¶é—´
            updateTime();
        }
        
        // ç”Ÿæˆæ¸¸å®¢ç»Ÿè®¡æ•°æ®çš„å‡½æ•°
        function generateVisitorStatistics() {
            return {
                totalVisitors: Math.floor(Math.random() * 5000) + 1000,
                monthlyGrowth: (Math.random() * 20 + 5).toFixed(1),
                averageStay: (Math.random() * 3 + 2).toFixed(1),
                visitorOrigins: [
                    { region: 'æœ¬åœ°æ¸¸å®¢', percentage: 35, count: Math.floor(Math.random() * 1000) + 500 },
                    { region: 'çœå†…æ¸¸å®¢', percentage: 25, count: Math.floor(Math.random() * 800) + 300 },
                    { region: 'çœå¤–æ¸¸å®¢', percentage: 30, count: Math.floor(Math.random() * 900) + 400 },
                    { region: 'å›½é™…æ¸¸å®¢', percentage: 10, count: Math.floor(Math.random() * 300) + 100 }
                ]
            };
        }
        
        // æ”¶å…¥ç»Ÿè®¡
        function showIncomeStatistics() {
            const statistics = generateIncomeStatistics();
            
            document.querySelector('.map-container').innerHTML = `
                <h2 class="map-title">æ”¶å…¥ç»Ÿè®¡</h2>
                
                <div style="background: rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 30px; margin: 20px 0;">
                    <h3 style="color: white; text-align: center; margin-bottom: 20px;">æœˆåº¦æ”¶å…¥ç»Ÿè®¡ï¼ˆä¸‡å…ƒï¼‰</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 15px; text-align: center;">
                            <div style="font-size: 2rem; color: #4CAF50; font-weight: bold;">${statistics.totalIncome}</div>
                            <div style="color: white;">æ€»æ”¶å…¥</div>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 15px; text-align: center;">
                            <div style="font-size: 2rem; color: #2196F3; font-weight: bold;">${statistics.tourismIncome}</div>
                            <div style="color: white;">æ—…æ¸¸æ”¶å…¥</div>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 15px; text-align: center;">
                            <div style="font-size: 2rem; color: #FF9800; font-weight: bold;">${statistics.accommodationIncome}</div>
                            <div style="color: white;">æ°‘å®¿æ”¶å…¥</div>
                        </div>
                    </div>
                </div>
                
                <div style="background: rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 30px; margin: 20px 0;">
                    <h3 style="color: white; text-align: center; margin-bottom: 20px;">æ”¶å…¥æ„æˆåˆ†æ</h3>
                    <div style="color: white; line-height: 1.8;">
                        ${statistics.incomeBreakdown.map(item => 
                            `<div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>${item.category}</span>
                                <span>${item.amount}ä¸‡å…ƒ (${item.percentage}%)</span>
                            </div>`
                        ).join('')}
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 40px;">
                    <button class="search-btn" onclick="showStatistics()" style="margin-right: 15px;">è¿”å›ç»Ÿè®¡</button>
                    <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
                
                <div class="current-time" id="currentTime"></div>
            `;
            
            // æ›´æ–°æ—¶é—´
            updateTime();
        }
        
        // ç”Ÿæˆæ”¶å…¥ç»Ÿè®¡æ•°æ®çš„å‡½æ•°
        function generateIncomeStatistics() {
            const tourismIncome = (Math.random() * 50 + 20).toFixed(1);
            const accommodationIncome = (Math.random() * 30 + 10).toFixed(1);
            const productIncome = (Math.random() * 20 + 5).toFixed(1);
            const totalIncome = (parseFloat(tourismIncome) + parseFloat(accommodationIncome) + parseFloat(productIncome)).toFixed(1);
            
            return {
                totalIncome: totalIncome,
                tourismIncome: tourismIncome,
                accommodationIncome: accommodationIncome,
                incomeBreakdown: [
                    { category: 'æ—…æ¸¸é—¨ç¥¨æ”¶å…¥', amount: tourismIncome, percentage: ((parseFloat(tourismIncome) / parseFloat(totalIncome)) * 100).toFixed(1) },
                    { category: 'æ°‘å®¿ä½å®¿æ”¶å…¥', amount: accommodationIncome, percentage: ((parseFloat(accommodationIncome) / parseFloat(totalIncome)) * 100).toFixed(1) },
                    { category: 'å†œäº§å“é”€å”®', amount: productIncome, percentage: ((parseFloat(productIncome) / parseFloat(totalIncome)) * 100).toFixed(1) }
                ]
            };
        }
        
        // èµ„æºç®¡ç†åŠŸèƒ½
        function showResourceManagement() {
            alert('èµ„æºç®¡ç†åŠŸèƒ½å¼€å‘ä¸­...åŠŸèƒ½åŒ…æ‹¬ï¼šâ€¢ æ°‘å®¿èµ„æºç®¡ç†â€¢ æ™¯ç‚¹è®¾æ–½ç®¡ç†â€¢ å†œäº§å“èµ„æºç®¡ç†â€¢ äººåŠ›èµ„æºç»Ÿè®¡');
        }
        
        // ä¹¡æ‘è§„åˆ’åŠŸèƒ½
        function showVillagePlanning() {
            alert('ä¹¡æ‘è§„åˆ’åŠŸèƒ½å¼€å‘ä¸­...åŠŸèƒ½åŒ…æ‹¬ï¼šâ€¢ æ—…æ¸¸å‘å±•è§„åˆ’â€¢ åŸºç¡€è®¾æ–½å»ºè®¾è§„åˆ’â€¢ ç¯å¢ƒä¿æŠ¤è§„åˆ’â€¢ äº§ä¸šå‘å±•è§„åˆ’');
        }
        
        // æ”¿ç­–ç®¡ç†åŠŸèƒ½
        function showPolicyManagement() {
            alert('æ”¿ç­–ç®¡ç†åŠŸèƒ½å¼€å‘ä¸­...åŠŸèƒ½åŒ…æ‹¬ï¼šâ€¢ æ”¿ç­–å‘å¸ƒç®¡ç†â€¢ ç®¡ç†åŠæ³•åˆ¶å®šâ€¢ é€šçŸ¥å…¬å‘Šå‘å¸ƒâ€¢ æ”¿ç­–æ•ˆæœè¯„ä¼°');
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const username = localStorage.getItem('username');
            const userType = localStorage.getItem('userType');
            
            if (!isLoggedIn || isLoggedIn !== 'true' || !username) {
                window.location.href = 'index.html';
                return;
            }
            
            // æ ¹æ®ç”¨æˆ·ç±»å‹æ˜¾ç¤ºä¸åŒç•Œé¢
            if (userType === 'village') {
                document.getElementById('welcomeText').textContent = `æ¬¢è¿æ‘å§”ç®¡ç†å‘˜ ${username}ï¼`;
                initMap();
                // æ·»åŠ æ‘å§”èœå•æŒ‰é’®
                addRoleMenuButton('village');
            } else if (userType === 'cooperative') {
                document.getElementById('welcomeText').textContent = `æ¬¢è¿åˆä½œç¤¾ç®¡ç†å‘˜ ${username}ï¼`;
                initMap();
                // æ·»åŠ åˆä½œç¤¾èœå•æŒ‰é’®
                addRoleMenuButton('cooperative');
            } else if (userType === 'enterprise') {
                document.getElementById('welcomeText').textContent = `æ¬¢è¿æ—…æ¸¸ä¼ä¸šç®¡ç†å‘˜ ${username}ï¼`;
                initMap();
                // æ·»åŠ æ—…æ¸¸ä¼ä¸šèœå•æŒ‰é’®
                addRoleMenuButton('enterprise');
            } else {
                document.getElementById('welcomeText').textContent = `æ¬¢è¿å›æ¥ï¼Œ${username}ï¼å¼€å§‹æ¢ç´¢ç²¾å½©ä¸–ç•Œ`;
                initMap();
            }
            
            // æ›´æ–°æ—¶é—´
            updateTime();
            setInterval(updateTime, 1000);
        });
    </script>
</body>
</html>